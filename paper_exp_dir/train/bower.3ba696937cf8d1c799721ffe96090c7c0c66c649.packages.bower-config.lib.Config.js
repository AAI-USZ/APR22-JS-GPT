var lang = require('mout/lang');
var object = require('mout/object');
var rc = require('./util/rc');
var defaults = require('./util/defaults');
var expand = require('./util/expand');
var EnvProxy = require('./util/proxy');
var path = require('path');
var fs = require('fs');

function Config(cwd) {
this._cwd = cwd || process.cwd();
this._proxy = new EnvProxy();
this._config = {};
}

Config.prototype.load = function (overwrites) {
this._config = rc('bower', defaults, this._cwd);

this._config = Config.normalise(this._config);

this._config = object.merge(this._config, overwrites || {});

loadCAs(this._config.ca);

this._proxy.set(this._config);

return this;
};

Config.prototype.restore = function () {
this._proxy.restore();
};

function readCertFile(path) {
path = path || '';

var sep = '-----END CERTIFICATE-----';

var certificates;

if (path.indexOf(sep) === -1) {
certificates = fs.readFileSync(path, { encoding: 'utf8' });
} else {
certificates = path;
}

return certificates
.split(sep)
.filter(function(s) { return !s.match(/^\s*$/); })
.map(function(s) { return s + sep; });
}

function loadCAs(caConfig) {



if (caConfig.search) {
caConfig.search = caConfig.search.map(function(s) {
return readCertFile(s);
});
}
['register', 'publish'].forEach(function(p) {
if (caConfig[p]) {
caConfig[p] = readCertFile(caConfig[p]);
}
});
}

Config.prototype.toObject = function () {
return lang.deepClone(this._config);
};

Config.create = function (cwd) {
return new Config(cwd);
};

Config.read = function (cwd, overrides) {
var config = new Config(cwd);
return config.load(overrides).toObject();
};

Config.normalise = function (rawConfig) {
var config = {};


object.deepMixIn(config, expand(defaults), expand(rawConfig));


config.shorthandResolver = config.shorthandResolver
.replace(/\{\{\{/g, '{{')
.replace(/\}\}\}/g, '}}');


config.registry.search = config.registry.search.map(function (url) {
return url.replace(/\/+$/, '');
});
config.registry.register = config.registry.register.replace(/\/+$/, '');
config.registry.publish = config.registry.publish.replace(/\/+$/, '');
config.tmp = path.resolve(config.tmp);

return config;
};

Config.DEFAULT_REGISTRY = defaults.registry;

module.exports = Config;
